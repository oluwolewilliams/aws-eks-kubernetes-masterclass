apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: eks-microservices-demo
  labels:
    app: usermgmt-restapp
  annotations:
    # Use AWS Load Balancer Controller (ALB)
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance # NodePort backend -> instance; use 'ip' for ClusterIP
    # Health checks
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/healthcheck-port: traffic-port
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '15'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/success-codes: '200'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'
    # HTTPS + HTTP->HTTPS redirect
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443},{"HTTP":80}]'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:786359466063:certificate/2e4b3e7a-0b64-4faf-9777-20c9971ee152
    alb.ingress.kubernetes.io/actions.ssl-redirect: >
      {"Type":"redirect","RedirectConfig":{"Protocol":"HTTPS","Port":"443","StatusCode":"HTTP_301"}}
    # ExternalDNS will create records for both hosts
    external-dns.alpha.kubernetes.io/hostname: services.oluwolewilliams.com, ums.oluwolewilliams.com
spec:
  ingressClassName: alb # preferred in v1 (you can omit kubernetes.io/ingress.class)
  rules:
  - host: services.oluwolewilliams.com
    http:
      paths:
      # Redirect HTTP -> HTTPS
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ssl-redirect
            port:
              name: use-annotation
      # Application backend
      - path: /
        pathType: Prefix
        backend:
          service:
            name: usermgmt-restapp-nodeport-service
            port:
              number: 8095
  - host: ums.oluwolewilliams.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ssl-redirect
            port:
              name: use-annotation
      - path: /
        pathType: Prefix
        backend:
          service:
            name: usermgmt-restapp-nodeport-service
            port:
              number: 8095
